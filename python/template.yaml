AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: "Durable Executions with AI - Python (uksb-qfdtv4ip1c) (tag: python)"

Globals:
  Function:
    Runtime: python3.14
    Timeout: 30
    MemorySize: 256
    Architectures:
      - arm64

Resources:
  DurableFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DurableExecutionPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:CheckpointDurableExecution
                  - lambda:GetDurableExecutionState
                Resource: !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
        - PolicyName: BedrockPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                Resource:
                  - "arn:aws:bedrock:*::foundation-model/*"
                  - "arn:aws:bedrock:*:*:inference-profile/*"

  PromptChainingFunction:
    Type: AWS::Serverless::Function
    # checkov:skip=CKV_AWS_115:Reserved concurrency not appropriate
    # checkov:skip=CKV_AWS_116:DLQ not appropriate
    # checkov:skip=CKV_AWS_117:VPC not appropriate
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: VPC not appropriate
          - id: W92
            reason: Reserved concurrency not appropriate
    Properties:
      Handler: src.prompt_chaining.handler
      CodeUri: package.zip
      Role: !GetAtt DurableFunctionRole.Arn
      DurableConfig:
        ExecutionTimeout: 900
        RetentionPeriodInDays: 7

  LlmAsJudgeFunction:
    Type: AWS::Serverless::Function
    # checkov:skip=CKV_AWS_115:Reserved concurrency not appropriate
    # checkov:skip=CKV_AWS_116:DLQ not appropriate
    # checkov:skip=CKV_AWS_117:VPC not appropriate
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: VPC not appropriate
          - id: W92
            reason: Reserved concurrency not appropriate
    Properties:
      Handler: src.llm_as_judge.handler
      CodeUri: package.zip
      Role: !GetAtt DurableFunctionRole.Arn
      DurableConfig:
        ExecutionTimeout: 900
        RetentionPeriodInDays: 7

  HumanReviewFunction:
    Type: AWS::Serverless::Function
    # checkov:skip=CKV_AWS_115:Reserved concurrency not appropriate
    # checkov:skip=CKV_AWS_116:DLQ not appropriate
    # checkov:skip=CKV_AWS_117:VPC not appropriate
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: VPC not appropriate
          - id: W92
            reason: Reserved concurrency not appropriate
    Properties:
      Handler: src.human_review.handler
      CodeUri: package.zip
      Role: !GetAtt DurableFunctionRole.Arn
      DurableConfig:
        ExecutionTimeout: 900
        RetentionPeriodInDays: 7

  AgentFunction:
    Type: AWS::Serverless::Function
    # checkov:skip=CKV_AWS_115:Reserved concurrency not appropriate
    # checkov:skip=CKV_AWS_116:DLQ not appropriate
    # checkov:skip=CKV_AWS_117:VPC not appropriate
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: VPC not appropriate
          - id: W92
            reason: Reserved concurrency not appropriate
    Properties:
      Handler: src.agent.handler
      CodeUri: package.zip
      Role: !GetAtt DurableFunctionRole.Arn
      DurableConfig:
        ExecutionTimeout: 900
        RetentionPeriodInDays: 7

  ParallelInvocationFunction:
    Type: AWS::Serverless::Function
    # checkov:skip=CKV_AWS_115:Reserved concurrency not appropriate
    # checkov:skip=CKV_AWS_116:DLQ not appropriate
    # checkov:skip=CKV_AWS_117:VPC not appropriate
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: VPC not appropriate
          - id: W92
            reason: Reserved concurrency not appropriate
    Properties:
      Handler: src.parallel_invocation.handler
      CodeUri: package.zip
      Role: !GetAtt DurableFunctionRole.Arn
      DurableConfig:
        ExecutionTimeout: 900
        RetentionPeriodInDays: 7

  StructuredOutputFunction:
    Type: AWS::Serverless::Function
    # checkov:skip=CKV_AWS_115:Reserved concurrency not appropriate
    # checkov:skip=CKV_AWS_116:DLQ not appropriate
    # checkov:skip=CKV_AWS_117:VPC not appropriate
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W89
            reason: VPC not appropriate
          - id: W92
            reason: Reserved concurrency not appropriate
    Properties:
      Handler: src.structured_output.handler
      CodeUri: package.zip
      Role: !GetAtt DurableFunctionRole.Arn
      DurableConfig:
        ExecutionTimeout: 900
        RetentionPeriodInDays: 7

Outputs:
  PromptChainingFunction:
    Value: !GetAtt PromptChainingFunction.Arn
  LlmAsJudgeFunction:
    Value: !GetAtt LlmAsJudgeFunction.Arn
  HumanReviewFunction:
    Value: !GetAtt HumanReviewFunction.Arn
  AgentFunction:
    Value: !GetAtt AgentFunction.Arn
  ParallelInvocationFunction:
    Value: !GetAtt ParallelInvocationFunction.Arn
  StructuredOutputFunction:
    Value: !GetAtt StructuredOutputFunction.Arn
